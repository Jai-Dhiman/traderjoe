name: Morning Trading Routine

on:
  schedule:
    # Run at 6:30 AM PST (9:30 AM ET) on weekdays
    # PST is UTC-8, so 6:30 AM PST = 14:30 UTC (2:30 PM UTC)
    - cron: "30 14 * * 1-5"
  workflow_dispatch: # Allow manual trigger for testing

env:
  RUST_BACKTRACE: 1
  RUST_LOG: traderjoe=info,sqlx=warn
  LLM_PROVIDER: cerebras
  PRIMARY_MODEL: llama-3.3-70b
  FALLBACK_MODEL: llama-3.1-8b

jobs:
  morning_analysis:
    runs-on: ubuntu-latest
    # Only run on weekdays during market hours
    if: github.event_name == 'workflow_dispatch' || (github.event.schedule && github.event_name == 'schedule')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          # Cache key includes Cargo.lock for dependency changes
          # Automatically handles target/ and ~/.cargo caching
          shared-key: "release"
          cache-on-failure: true

      - name: Build TraderJoe
        env:
          SQLX_OFFLINE: true
        run: cargo build --release

      - name: Test Database Connection
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "🔍 Testing database connection..."

          if [ -z "$DATABASE_URL" ]; then
            echo "❌ ERROR: DATABASE_URL secret is not set!"
            exit 1
          fi

          echo "✅ DATABASE_URL secret is set"

          echo "Testing database connection with traderjoe --help..."
          if ./target/release/traderjoe --help 2>&1; then
            echo "✅ Database connection successful!"
          else
            echo "❌ Database connection failed"
            exit 1
          fi

      - name: Fetch Latest Market Data
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
        run: |
          echo "Fetching market data for SPY..."
          ./target/release/traderjoe fetch --symbol SPY --data-type ohlcv --days 5

      - name: Run Morning Analysis (ACE Pipeline)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          PAPER_TRADING: true
        run: |
          set +e  # Disable exit on error for the entire script

          echo "=== Environment Check ==="
          echo "LLM_PROVIDER: $LLM_PROVIDER"
          echo "PRIMARY_MODEL: $PRIMARY_MODEL"
          echo "FALLBACK_MODEL: $FALLBACK_MODEL"
          echo "CEREBRAS_API_KEY: ${CEREBRAS_API_KEY:0:10}..."
          echo "========================="

          echo "Running morning analysis..."
          ./target/release/traderjoe analyze --symbol SPY 2>&1 | tee /tmp/analysis_output.txt
          EXIT_CODE=${PIPESTATUS[0]}

          echo ""
          echo "Exit code: $EXIT_CODE"

          if [ $EXIT_CODE -ne 0 ]; then
            echo "❌ Analysis failed with exit code $EXIT_CODE"
            echo "Full output above and saved to /tmp/analysis_output.txt"
            exit $EXIT_CODE
          fi

          echo "✅ Analysis completed successfully"

      - name: Auto-Execute Trade if Confidence Threshold Met
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PAPER_TRADING: true
        run: |
          echo "Checking auto-execution criteria..."

          # Confidence threshold (0.50 for learning phase)
          CONFIDENCE_THRESHOLD=0.50

          # Extract recommendation ID
          RECOMMENDATION_ID=$(cat /tmp/analysis_output.txt | grep -oE '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}' | head -1)

          if [[ -n "$RECOMMENDATION_ID" ]]; then
            echo "Found recommendation ID: $RECOMMENDATION_ID"

            # Extract confidence
            CONFIDENCE=$(cat /tmp/analysis_output.txt | grep -i "confidence" | grep -oE '[0-9]+(\.[0-9]+)?' | head -1)

            if [[ -n "$CONFIDENCE" ]]; then
              # Convert percentage to decimal if needed
              if (( $(echo "$CONFIDENCE > 1" | bc -l) )); then
                CONFIDENCE=$(echo "scale=2; $CONFIDENCE / 100" | bc)
              fi

              echo "Confidence: $CONFIDENCE (threshold: $CONFIDENCE_THRESHOLD)"

              # Execute if confidence meets threshold
              if (( $(echo "$CONFIDENCE >= $CONFIDENCE_THRESHOLD" | bc -l) )); then
                echo "Confidence meets threshold - AUTO-EXECUTING TRADE"
                echo "(Paper trading mode - no real money at risk)"
                ./target/release/traderjoe execute --recommendation-id "$RECOMMENDATION_ID"
              else
                echo "Confidence below threshold - SKIPPING execution"
              fi
            else
              echo "Could not parse confidence - SKIPPING execution"
            fi
          else
            echo "No recommendation ID found - SKIPPING execution"
          fi

      - name: Display Account Status
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          echo "Current positions:"
          ./target/release/traderjoe positions

      - name: Display ACE Playbook Stats
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ACE Playbook statistics:"
          ./target/release/traderjoe playbook-stats

      - name: Upload Analysis Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: morning-analysis-logs-${{ github.run_number }}
          path: /tmp/analysis_output.txt
          retention-days: 30
